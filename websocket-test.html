<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - Market Service</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <h1>Test WebSocket Market Service</h1>
    
    <div>
        <label for="jwtToken">JWT Token:</label>
        <input type="text" id="jwtToken" placeholder="Collez votre JWT ici" style="width: 400px;">
    </div>
    <br>

    <div>
        <button onclick="connect()">Se connecter</button>
        <button onclick="disconnect()">Se d√©connecter</button>
        <button onclick="subscribeToAll()">S'abonner √† tous</button>
        <button onclick="subscribeToSymbol('AAPL')">S'abonner √† AAPL</button>
    </div>
    
    <div>
        <h3>Logs:</h3>
        <div id="logs" style="border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px;"></div>
    </div>

    <script>
        let stompClient = null;
        
        function log(message) {
            const logs = document.getElementById('logs');
            logs.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            logs.scrollTop = logs.scrollHeight;
        }
        
        function connect() {
            const token = document.getElementById('jwtToken').value.trim();
            if (!token) {
                log("‚ö†Ô∏è Aucun JWT fourni !");
                return;
            }

            const socket = new WebSocket('ws://localhost:8080/ws/market'); 
            stompClient = Stomp.over(socket);
            
            stompClient.connect(
                { Authorization: "Bearer " + token }, // headers envoy√©s
                function(frame) {
                    log('‚úÖ Connect√©: ' + frame);
                },
                function(error) {
                    log('‚ùå Erreur de connexion: ' + error);
                }
            );
        }
        
        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                log('üîå D√©connect√©');
            }
        }
        
        function subscribeToAll() {
            if (stompClient && stompClient.connected) {
                stompClient.subscribe('/topic/market/all', function(message) {
                    log('üì© Message re√ßu (all): ' + message.body);
                });
                log('üì° Abonn√© √† /topic/market/all');
            } else {
                log('‚ö†Ô∏è Pas connect√©!');
            }
        }
        
        function subscribeToSymbol(symbol) {
            if (stompClient && stompClient.connected) {
                stompClient.subscribe('/topic/market/' + symbol, function(message) {
                    log('üì© Message re√ßu (' + symbol + '): ' + message.body);
                });
                log('üì° Abonn√© √† /topic/market/' + symbol);
                
                // Envoie aussi une demande d'abonnement c√¥t√© backend
                stompClient.send('/app/market/subscribe', {}, JSON.stringify({
                    action: 'subscribe',
                    symbols: [symbol]
                }));
            } else {
                log('‚ö†Ô∏è Pas connect√©!');
            }
        }
    </script>
</body>
</html>
